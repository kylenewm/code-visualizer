<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeFlow Visualizer - System Walkthrough</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0d1117;
            color: #c9d1d9;
            line-height: 1.7;
        }
        .hero {
            background: linear-gradient(135deg, #161b22 0%, #0d1117 100%);
            padding: 4rem 2rem;
            text-align: center;
            border-bottom: 1px solid #30363d;
        }
        .hero h1 {
            font-size: 2.5rem;
            color: #f0f6fc;
            margin-bottom: 1rem;
        }
        .hero p { color: #8b949e; font-size: 1.2rem; }

        .container { max-width: 1000px; margin: 0 auto; padding: 2rem; }

        h2 {
            color: #58a6ff;
            margin: 3rem 0 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #21262d;
        }
        h3 { color: #f0f6fc; margin: 1.5rem 0 1rem; }

        .phase {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 12px;
            margin: 2rem 0;
            overflow: hidden;
        }
        .phase-header {
            background: #21262d;
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .phase-number {
            background: #58a6ff;
            color: #0d1117;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .phase-title { font-size: 1.1rem; font-weight: 600; color: #f0f6fc; }
        .phase-time { margin-left: auto; color: #8b949e; font-size: 0.85rem; }
        .phase-content { padding: 1.5rem; }

        .terminal {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 1rem 1.25rem;
            font-family: 'SF Mono', 'Consolas', monospace;
            font-size: 0.9rem;
            overflow-x: auto;
            margin: 1rem 0;
        }
        .terminal pre { white-space: pre-wrap; }
        .prompt { color: #8b949e; }
        .cmd { color: #79c0ff; }
        .out { color: #c9d1d9; }
        .ok { color: #3fb950; }
        .err { color: #f85149; }
        .warn { color: #d29922; }
        .dim { color: #484f58; }
        .file { color: #d2a8ff; }

        .diagram {
            background: #1c2128;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            font-family: 'SF Mono', monospace;
            font-size: 0.85rem;
            overflow-x: auto;
        }

        .info-box {
            background: #1c2128;
            border-left: 4px solid #58a6ff;
            padding: 1rem 1.25rem;
            margin: 1rem 0;
            border-radius: 0 8px 8px 0;
        }
        .info-box.success { border-left-color: #3fb950; }
        .info-box.warning { border-left-color: #d29922; }
        .info-box.error { border-left-color: #f85149; }

        .arrow {
            text-align: center;
            color: #30363d;
            font-size: 1.5rem;
            padding: 0.5rem;
        }

        .split {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        @media (max-width: 768px) {
            .split { grid-template-columns: 1fr; }
        }

        .agent-card {
            background: #21262d;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 1rem;
        }
        .agent-name { color: #58a6ff; font-weight: 600; margin-bottom: 0.5rem; }
        .agent-status { font-size: 0.9rem; }

        .badge {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .badge-ready { background: #238636; }
        .badge-working { background: #1f6feb; }
        .badge-done { background: #3fb950; color: #0d1117; }
        .badge-queue { background: #6e7681; }

        .config-file {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            overflow: hidden;
        }
        .config-header {
            background: #21262d;
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
            color: #8b949e;
            border-bottom: 1px solid #30363d;
        }
        .config-body {
            padding: 1rem;
            font-family: 'SF Mono', monospace;
            font-size: 0.85rem;
        }

        .step-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }
        .step-card {
            background: #21262d;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 1.25rem;
        }
        .step-card h4 {
            color: #58a6ff;
            font-size: 0.9rem;
            margin-bottom: 0.75rem;
        }
        .step-card p {
            color: #8b949e;
            font-size: 0.85rem;
        }

        footer {
            text-align: center;
            padding: 3rem 2rem;
            border-top: 1px solid #21262d;
            color: #484f58;
            font-size: 0.85rem;
        }
    </style>
</head>
<body>

<div class="hero">
    <h1>CodeFlow Visualizer: System Walkthrough</h1>
    <p>From code change to semantic understanding - the complete data flow</p>
    <p style="margin-top: 1rem; padding: 0.5rem 1rem; background: #21262d; border-radius: 6px; display: inline-block; font-size: 0.85rem; color: #8b949e;">
        Note: This document covers backend, semantic layer, and Claude integration. <br>
        UI/Visualization (React, D3) not included — see the running app at <code style="color: #58a6ff;">localhost:3001</code>
    </p>
</div>

<div class="container">

<!-- OVERVIEW -->
<h2>The Big Picture</h2>

<p>CodeFlow tracks every code change, analyzes it with tree-sitter, builds a call graph, and layers semantic meaning on top. The result: you (and Claude) can understand what code <em>does</em>, not just what it <em>is</em>.</p>

<div class="diagram">
<pre>
<span class="dim">The Complete Flow:</span>

  <span class="ok">CODE CHANGE</span>              <span class="cmd">ANALYSIS</span>                <span class="file">SEMANTIC LAYER</span>           <span class="warn">OUTPUT</span>
       |                      |                         |                     |
       v                      v                         v                     v
  +-----------+         +-----------+            +-------------+        +-----------+
  | Claude    |         | tree-     |            | Annotations |        | REST API  |
  | Hooks     |-------->| sitter    |----------->| Drift       |------->| WebSocket |
  | or        |         | Parse     |            | Concepts    |        | MCP       |
  | Watcher   |         | Extract   |            | Invariants  |        | (Claude)  |
  +-----------+         +-----------+            +-------------+        +-----------+
       |                      |                         |                     |
       v                      v                         v                     v
  FileChangeEvent        GraphNode              SemanticAnnotation      JSON/Events
                         GraphEdge              DriftEvent
                                                ConceptDomain

<span class="dim">Storage: SQLite (.codeflow/observability.db)</span>
</pre>
</div>

<!-- PHASE 1: ENTRY -->
<div class="phase">
    <div class="phase-header">
        <div class="phase-number">1</div>
        <div class="phase-title">Code Change Detection</div>
        <div class="phase-time">T+0ms</div>
    </div>
    <div class="phase-content">
        <p>A change happens. Two ways to detect it:</p>

        <div class="split">
            <div class="agent-card">
                <div class="agent-name" style="color: #3fb950;">Claude Hooks (Primary)</div>
                <div class="agent-status" style="font-size: 0.85rem;">
                    <strong>When:</strong> Claude Code writes/edits a file<br><br>
                    <strong>How:</strong> PostToolUse hook fires with file path + content<br><br>
                    <strong>File:</strong> <code>src/hooks/adapter.ts</code><br><br>
                    <span class="badge badge-ready">INSTANT</span> No filesystem delay
                </div>
            </div>
            <div class="agent-card">
                <div class="agent-name" style="color: #d29922;">File Watcher (Fallback)</div>
                <div class="agent-status" style="font-size: 0.85rem;">
                    <strong>When:</strong> Any file change (manual edit, git, etc)<br><br>
                    <strong>How:</strong> chokidar watches filesystem<br><br>
                    <strong>File:</strong> <code>src/hooks/file-watcher.ts</code><br><br>
                    <span class="badge badge-queue">500ms</span> Debounced
                </div>
            </div>
        </div>

        <div class="terminal">
<pre><span class="dim"># Claude edits a file - hook fires immediately</span>
<span class="out">[ClaudeHook] PostToolUse: Edit</span>
<span class="out">  file: src/analyzer/pipeline.ts</span>
<span class="out">  tool: Edit</span>
<span class="out">  session: abc-123</span>

<span class="dim"># Output: FileChangeEvent</span>
<span class="ok">{</span>
  <span class="cmd">type</span>: 'modify',
  <span class="cmd">filePath</span>: 'src/analyzer/pipeline.ts',
  <span class="cmd">source</span>: '<span class="ok">claude_hook</span>',
  <span class="cmd">timestamp</span>: 1705234567890
<span class="ok">}</span></pre>
        </div>

        <div class="info-box">
            <strong>Why two sources?</strong>
            <ul style="margin-top: 0.5rem; padding-left: 1.25rem; color: #8b949e;">
                <li>Claude hooks = instant, precise, includes session context</li>
                <li>File watcher = catches everything else (manual edits, git operations)</li>
                <li>Both feed into the same pipeline</li>
            </ul>
        </div>
    </div>
</div>

<!-- PHASE 2: AGGREGATION -->
<div class="phase">
    <div class="phase-header">
        <div class="phase-number">2</div>
        <div class="phase-title">Change Aggregation</div>
        <div class="phase-time">T+0ms to T+1s</div>
    </div>
    <div class="phase-content">
        <p>Changes are batched to avoid analyzing the same file multiple times during rapid edits.</p>

        <div class="terminal">
<pre><span class="dim"># Multiple changes arrive rapidly</span>
<span class="out">[Aggregator] Change: src/api/routes.ts (modify)</span>
<span class="out">[Aggregator] Change: src/api/routes.ts (modify)</span>  <span class="dim"># same file again</span>
<span class="out">[Aggregator] Change: src/api/middleware.ts (modify)</span>

<span class="dim"># After 1 second window...</span>
<span class="out">[Aggregator] Batch ready: 2 files</span>
<span class="out">  src/api/routes.ts      (3 events merged)</span>
<span class="out">  src/api/middleware.ts  (1 event)</span>

<span class="dim"># Capture git diff for each</span>
<span class="out">[Aggregator] Running: git diff src/api/routes.ts</span>
<span class="ok">  +15 lines, -3 lines, 2 functions affected</span></pre>
        </div>

        <div class="config-file">
            <div class="config-header">src/hooks/change-aggregator.ts</div>
            <div class="config-body">
<pre><span class="dim">// Key data structures</span>

<span class="cmd">AggregatedChange</span> {
  filePath: string,
  lastType: 'create' | 'modify' | 'delete',
  source: 'claude_hook' | 'fs_watcher' | 'mixed',
  firstSeen: number,
  lastSeen: number,
  eventCount: number  <span class="dim">// How many times this file changed</span>
}

<span class="cmd">ChangeEvent</span> {
  id: string,         <span class="dim">// UUID</span>
  filePath: string,
  timestamp: number,
  diff: string,       <span class="dim">// Actual git diff output</span>
  affectedFunctions: string[],
  linesAdded: number,
  linesRemoved: number
}</pre>
            </div>
        </div>
    </div>
</div>

<!-- PHASE 3: ANALYSIS -->
<div class="phase">
    <div class="phase-header">
        <div class="phase-number">3</div>
        <div class="phase-title">Analysis Pipeline</div>
        <div class="phase-time">T+1s to T+1.1s</div>
    </div>
    <div class="phase-content">
        <p>tree-sitter parses the code, then we extract functions, classes, and call relationships.</p>

        <div class="diagram">
<pre>
<span class="dim">Phase A: Parsing (<100ms per file)</span>

  Source Code                    tree-sitter                  Syntax Tree
       |                              |                            |
       v                              v                            v
  +------------------+         +-------------+            +------------------+
  | function foo() { |         | Language:   |            | FunctionDecl     |
  |   bar();         |  -----> | TypeScript  |  ------->  |   name: "foo"    |
  |   return x;      |         | Parser      |            |   body:          |
  | }                |         +-------------+            |     CallExpr     |
  +------------------+                                    |       "bar"      |
                                                          +------------------+

<span class="dim">Phase B: Extraction</span>

  Syntax Tree                    Extractor                    Graph Elements
       |                              |                            |
       v                              v                            v
  +------------------+         +----------------+          +------------------+
  | FunctionDecl     |         | Walk AST       |          | <span class="ok">GraphNode</span>        |
  |   name: "foo"    |  -----> | Extract:       |  ----->  |   id: "file:fn:  |
  |   body:          |         |  - functions   |          |        foo:abc"  |
  |     CallExpr     |         |  - classes     |          |   kind: function |
  |       "bar"      |         |  - calls       |          |   name: "foo"    |
  +------------------+         |  - params      |          |   exported: true |
                               |  - types       |          |   contentHash:   |
                               +----------------+          |     "sha256..."  |
                                                           +------------------+
                                                           | <span class="cmd">GraphEdge</span>        |
                                                           |   source: foo    |
                                                           |   target: bar    |
                                                           |   type: calls    |
                                                           +------------------+
</pre>
        </div>

        <div class="terminal">
<pre><span class="dim"># Analysis output</span>
<span class="out">[Pipeline] Analyzing: src/api/routes.ts</span>
<span class="out">  Language: TypeScript</span>
<span class="out">  Parse time: 12ms</span>
<span class="out">  Extracted:</span>
<span class="ok">    5 functions</span>
<span class="ok">    1 class</span>
<span class="ok">    12 call edges</span>

<span class="dim"># Content hash calculated for each function</span>
<span class="out">  handleRequest: sha256:abc123...</span>
<span class="out">  validateInput: sha256:def456...</span></pre>
        </div>

        <div class="info-box">
            <strong>Why content hash?</strong>
            <p style="color: #8b949e; margin-top: 0.5rem;">
                The hash is calculated from function signature + body. When code changes, the hash changes. This lets us detect when an annotation becomes <em>stale</em> - the code changed but the annotation didn't.
            </p>
        </div>
    </div>
</div>

<!-- PHASE 4: GRAPH -->
<div class="phase">
    <div class="phase-header">
        <div class="phase-number">4</div>
        <div class="phase-title">Graph Building</div>
        <div class="phase-time">T+1.1s</div>
    </div>
    <div class="phase-content">
        <p>Nodes and edges are added to the in-memory graph with multiple indexes for fast queries.</p>

        <div class="config-file">
            <div class="config-header">src/graph/graph.ts - CodeGraph</div>
            <div class="config-body">
<pre><span class="dim">// In-memory indexed graph</span>

<span class="cmd">nodes</span>: Map&lt;nodeId, GraphNode&gt;        <span class="dim">// All nodes</span>
<span class="cmd">edges</span>: Map&lt;edgeId, GraphEdge&gt;        <span class="dim">// All edges</span>

<span class="dim">// Indexes for fast queries</span>
<span class="cmd">nodesByFile</span>: Map&lt;path, Set&lt;nodeId&gt;&gt;  <span class="dim">// "What functions are in this file?"</span>
<span class="cmd">nodesByKind</span>: Map&lt;kind, Set&lt;nodeId&gt;&gt;  <span class="dim">// "Give me all functions"</span>
<span class="cmd">nodesByName</span>: Map&lt;name, Set&lt;nodeId&gt;&gt;  <span class="dim">// "Find functions named 'handle*'"</span>

<span class="cmd">outgoingEdges</span>: Map&lt;nodeId, Set&gt;     <span class="dim">// "What does this function call?"</span>
<span class="cmd">incomingEdges</span>: Map&lt;nodeId, Set&gt;     <span class="dim">// "What calls this function?"</span></pre>
            </div>
        </div>

        <div class="terminal">
<pre><span class="dim"># Graph state after analysis</span>
<span class="prompt">$</span> <span class="cmd">curl localhost:3001/api/stats</span>

{
  "graph": {
    "<span class="ok">nodeCount</span>": 85,
    "<span class="cmd">edgeCount</span>": 142,
    "<span class="file">fileCount</span>": 14,
    "functionCount": 67,
    "classCount": 7
  }
}</pre>
        </div>

        <h3>Node Identity</h3>
        <p>Every node has a <strong>stable ID</strong> that survives refactoring:</p>

        <div class="diagram">
<pre>
<span class="dim">Node ID Format:</span>

  <span class="cmd">id</span>: "${fileHash}:${kind}:${name}:${signatureHash}"
       |            |       |        |
       |            |       |        +-- Changes if params/return type change
       |            |       +----------- Function name
       |            +------------------- "function", "class", "method"
       +-------------------------------- Hash of file path (survives moves)

  <span class="ok">stableId</span>: "${fileHash}:${kind}:${name}"
            |
            +-- Annotations attach here (survives signature changes)

<span class="dim">Example:</span>
  id:       "a1b2c3:function:handleRequest:x7y8z9"
  stableId: "a1b2c3:function:handleRequest"
</pre>
        </div>
    </div>
</div>

<!-- PHASE 5: SEMANTIC LAYER -->
<h2>The Semantic Layer</h2>

<p>This is where CodeFlow goes beyond just parsing. We add <em>meaning</em> to the code.</p>

<div class="phase">
    <div class="phase-header">
        <div class="phase-number">5</div>
        <div class="phase-title">Annotations</div>
    </div>
    <div class="phase-content">
        <p>Human or AI-generated descriptions of what functions <em>do</em>.</p>

        <div class="split">
            <div class="agent-card">
                <div class="agent-name">Without Annotation</div>
                <div class="agent-status" style="font-size: 0.85rem;">
<pre style="margin: 0; font-size: 0.8rem; color: #8b949e;">
function processPayment(
  userId: string,
  amount: number,
  cardToken: string
): Promise&lt;PaymentResult&gt;

<span class="dim">// You know the signature...</span>
<span class="dim">// But what does it actually DO?</span>
</pre>
                </div>
            </div>
            <div class="agent-card">
                <div class="agent-name" style="color: #3fb950;">With Annotation</div>
                <div class="agent-status" style="font-size: 0.85rem;">
<pre style="margin: 0; font-size: 0.8rem;">
<span class="ok">Annotation:</span>
"Charges the user's saved card,
applies discount codes, records
the transaction in the ledger,
and sends receipt email."

<span class="dim">// NOW you understand the blast radius</span>
</pre>
                </div>
            </div>
        </div>

        <div class="config-file">
            <div class="config-header">AnnotationVersion (stored in SQLite)</div>
            <div class="config-body">
<pre>{
  <span class="cmd">id</span>: 42,
  <span class="cmd">nodeId</span>: "a1b2:function:processPayment:x7y8",
  <span class="cmd">stableId</span>: "a1b2:function:processPayment",
  <span class="cmd">text</span>: "Charges the user's saved card...",
  <span class="cmd">contentHash</span>: "sha256:abc123",  <span class="dim">// Code hash when annotation created</span>
  <span class="cmd">source</span>: "claude",               <span class="dim">// or "manual"</span>
  <span class="cmd">createdAt</span>: 1705234567890,
  <span class="cmd">supersededAt</span>: null             <span class="dim">// null = current version</span>
}</pre>
            </div>
        </div>
    </div>
</div>

<!-- DRIFT DETECTION -->
<div class="phase">
    <div class="phase-header">
        <div class="phase-number">6</div>
        <div class="phase-title">Drift Detection</div>
    </div>
    <div class="phase-content">
        <p>When code changes but the annotation doesn't, we detect <strong>drift</strong>.</p>

        <div class="diagram">
<pre>
<span class="dim">Drift Detection Flow:</span>

  Old Code                    New Code                    Drift?
       |                          |                          |
       v                          v                          v
  +------------------+     +------------------+     +------------------+
  | contentHash:     |     | contentHash:     |     | Hashes differ!   |
  | "sha256:abc123"  | vs  | "sha256:def456"  | --> | <span class="warn">DRIFT DETECTED</span>   |
  |                  |     |                  |     |                  |
  | Annotation:      |     | Annotation:      |     | Severity: <span class="err">HIGH</span>   |
  | "Charges card"   |     | "Charges card"   |     | (50%+ changed)   |
  +------------------+     +------------------+     +------------------+

<span class="dim">Severity Levels:</span>
  <span class="ok">LOW</span>    - &lt;20% of code changed (minor tweak)
  <span class="warn">MEDIUM</span> - 20-50% changed (significant edit)
  <span class="err">HIGH</span>   - &gt;50% changed (major rewrite)
</pre>
        </div>

        <div class="terminal">
<pre><span class="dim"># Drift event recorded</span>
<span class="out">[DriftDetector] Drift detected:</span>
<span class="out">  function: processPayment</span>
<span class="out">  old hash: sha256:abc123</span>
<span class="out">  new hash: sha256:def456</span>
<span class="warn">  severity: HIGH</span>
<span class="out">  annotation: STALE (needs review)</span></pre>
        </div>
    </div>
</div>

<!-- CONCEPT SHIFTS -->
<div class="phase">
    <div class="phase-header">
        <div class="phase-number">7</div>
        <div class="phase-title">Concept Shift Detection</div>
    </div>
    <div class="phase-content">
        <p>Not just "code changed" but "did the <em>purpose</em> change?"</p>

        <div class="diagram">
<pre>
<span class="dim">Semantic Similarity via Embeddings:</span>

  Old Annotation                           New Code Behavior
       |                                         |
       v                                         v
  "Handles user authentication           "Processes payment transactions
   and creates login session"             and charges credit cards"
       |                                         |
       +------------------+  +-------------------+
                          |  |
                          v  v
                    +--------------+
                    | Embedding    |
                    | Comparison   |
                    | (MiniLM-L6)  |
                    +--------------+
                          |
                          v
                   Similarity: <span class="err">6.7%</span>
                          |
                          v
                    <span class="err">CONCEPT SHIFTED</span>
                    (was auth, now billing!)

<span class="dim">Thresholds:</span>
  <span class="ok">&gt;=85%</span>  SAME      - No shift, annotation still valid
  <span class="warn">50-85%</span> SIMILAR   - Unclear, may need review
  <span class="err">&lt;50%</span>   DIFFERENT - Purpose changed significantly
</pre>
        </div>

        <div class="info-box warning">
            <strong>Why this matters:</strong>
            <p style="color: #8b949e; margin-top: 0.5rem;">
                A function might keep the same name but completely change what it does. Concept shift detection catches when "handlePayment" used to validate cards but now sends emails. The <em>name</em> didn't change, but the <em>meaning</em> did.
            </p>
        </div>
    </div>
</div>

<!-- INVARIANTS -->
<div class="phase">
    <div class="phase-header">
        <div class="phase-number">8</div>
        <div class="phase-title">Invariants</div>
    </div>
    <div class="phase-content">
        <p>Hardcoded observability contracts - rules that should always be true.</p>

        <div class="step-grid">
            <div class="step-card" style="border-left: 3px solid #3fb950;">
                <h4>public-api-annotated</h4>
                <p>All exported functions must have annotations. Public API = documented API.</p>
            </div>
            <div class="step-card" style="border-left: 3px solid #d29922;">
                <h4>critical-paths-annotated</h4>
                <p>Functions with 3+ callers are "hotspots" - must be annotated.</p>
            </div>
            <div class="step-card" style="border-left: 3px solid #f85149;">
                <h4>no-high-drift-unresolved</h4>
                <p>High-severity drift can't stay unresolved. Fix or re-annotate.</p>
            </div>
            <div class="step-card" style="border-left: 3px solid #58a6ff;">
                <h4>no-unreviewed-shifts</h4>
                <p>Concept shifts must be reviewed. Purpose changes are dangerous.</p>
            </div>
        </div>

        <div class="terminal">
<pre><span class="prompt">$</span> <span class="cmd">curl localhost:3001/api/invariants</span>

{
  "summary": {
    "totalInvariants": 6,
    "passed": 4,
    "<span class="warn">violated</span>": 2
  },
  "results": [
    {
      "id": "public-api-annotated",
      "<span class="err">violated</span>": true,
      "targets": [
        { "name": "handleRequest", "reason": "Exported function without annotation" },
        { "name": "processQueue", "reason": "Exported function without annotation" }
      ]
    }
  ]
}</pre>
        </div>
    </div>
</div>

<!-- IMPACT ANALYSIS -->
<div class="phase">
    <div class="phase-header">
        <div class="phase-number">9</div>
        <div class="phase-title">Impact Analysis</div>
    </div>
    <div class="phase-content">
        <p>Before changing a function, know the <strong>blast radius</strong>.</p>

        <div class="diagram">
<pre>
<span class="dim">Impact Analysis for: get_subscription</span>

                        get_subscription
                              |
              +---------------+---------------+
              |               |               |
              v               v               v
        check_access    bill_user       send_invoice
              |               |
              v               v
        log_audit       update_ledger
                              |
                              v
                        notify_admin

<span class="ok">Direct callers:</span>     3 functions
<span class="warn">Transitive callers:</span> 6 functions total
<span class="err">Exported callers:</span>   2 (public API impact)

<span class="dim">Verdict: HIGH IMPACT - changes here ripple to 6 functions</span>
</pre>
        </div>
    </div>
</div>

<!-- STORAGE -->
<h2>Storage Layer</h2>

<div class="phase">
    <div class="phase-header">
        <div class="phase-number">10</div>
        <div class="phase-title">SQLite Database</div>
    </div>
    <div class="phase-content">
        <p>All semantic metadata persists in <code>.codeflow/observability.db</code>.</p>

        <div class="config-file">
            <div class="config-header">Database Schema</div>
            <div class="config-body">
<pre><span class="dim">-- Core tables</span>

<span class="cmd">annotation_versions</span>     <span class="dim">-- Function annotations with history</span>
  id, node_id, stable_id, text, content_hash,
  source, created_at, superseded_at, superseded_by

<span class="cmd">drift_events</span>            <span class="dim">-- When code changed but annotation didn't</span>
  id, node_id, old_hash, new_hash, severity,
  drift_type, detected_at, resolved_at

<span class="cmd">concept_domains</span>         <span class="dim">-- Semantic groupings (Auth, Billing, etc)</span>
  id, name, description, member_count

<span class="cmd">domain_members</span>          <span class="dim">-- Which functions belong to which domain</span>
  domain_id, node_id, similarity

<span class="cmd">module_annotations</span>      <span class="dim">-- Module-level summaries</span>
  id, module_path, summary, function_count

<span class="cmd">observability_rules</span>     <span class="dim">-- Custom rule definitions</span>
<span class="cmd">rule_evaluations</span>        <span class="dim">-- Rule evaluation history</span>
<span class="cmd">touched_functions</span>       <span class="dim">-- Recently modified functions</span></pre>
            </div>
        </div>

        <div class="info-box">
            <strong>Why SQLite?</strong>
            <ul style="margin-top: 0.5rem; padding-left: 1.25rem; color: #8b949e;">
                <li>Single file, no server needed</li>
                <li>WAL mode for concurrent access</li>
                <li>Portable - just copy the .db file</li>
                <li>Fast enough for visualization workloads</li>
            </ul>
        </div>
    </div>
</div>

<!-- OUTPUT -->
<h2>Output Layer</h2>

<div class="phase">
    <div class="phase-header">
        <div class="phase-number">11</div>
        <div class="phase-title">REST API + WebSocket + MCP</div>
        <div class="phase-time"><span class="badge badge-ready">WORKING</span></div>
    </div>
    <div class="phase-content">
        <p>Three ways to consume the data:</p>

        <div class="step-grid">
            <div class="step-card" style="border-left: 3px solid #3fb950;">
                <h4>REST API</h4>
                <p>Traditional HTTP endpoints. Query graph, search functions, get stats.</p>
                <code style="font-size: 0.75rem; color: #8b949e;">GET /api/graph, /api/search, /api/nodes/:id</code>
            </div>
            <div class="step-card" style="border-left: 3px solid #58a6ff;">
                <h4>WebSocket</h4>
                <p>Real-time updates. Get notified when graph changes, drift detected, etc.</p>
                <code style="font-size: 0.75rem; color: #8b949e;">ws://localhost:3001</code>
            </div>
            <div class="step-card" style="border-left: 3px solid #d2a8ff;">
                <h4>MCP Server</h4>
                <p>Model Context Protocol for Claude. Let AI query the graph directly.</p>
                <code style="font-size: 0.75rem; color: #8b949e;">search_functions, get_callers, analyze_impact</code>
            </div>
        </div>

        <h3>Key API Endpoints</h3>

        <div class="terminal">
<pre><span class="dim"># Get semantic snapshot (everything in one call)</span>
<span class="prompt">$</span> <span class="cmd">curl localhost:3001/api/snapshot</span>
{
  "domains": [...],        <span class="dim">// Concept groupings</span>
  "unreviewedShifts": [...], <span class="dim">// Purpose changes</span>
  "violations": [...],     <span class="dim">// Invariant violations</span>
  "hotspots": [...],       <span class="dim">// High-impact functions</span>
  "stats": {...}
}

<span class="dim"># Search for functions</span>
<span class="prompt">$</span> <span class="cmd">curl localhost:3001/api/search?q=payment</span>

<span class="dim"># Get callers of a function</span>
<span class="prompt">$</span> <span class="cmd">curl localhost:3001/api/nodes/abc123/callers</span>

<span class="dim"># Check invariants</span>
<span class="prompt">$</span> <span class="cmd">curl localhost:3001/api/invariants</span></pre>
        </div>

        <h3>WebSocket Events</h3>

        <div class="config-file">
            <div class="config-header">Real-time events</div>
            <div class="config-body">
<pre><span class="ok">graph:update</span>       <span class="dim">// Graph changed (new nodes/edges)</span>
<span class="cmd">analysis:start</span>     <span class="dim">// Analysis beginning</span>
<span class="cmd">analysis:complete</span>  <span class="dim">// Analysis finished</span>
<span class="warn">drift:detected</span>     <span class="dim">// Code changed, annotation stale</span>
<span class="err">rules:violation</span>   <span class="dim">// Invariant violated</span>
<span class="file">change:recorded</span>    <span class="dim">// Change event with git diff</span></pre>
            </div>
        </div>
    </div>
</div>

<!-- MCP TOOLS -->
<h2>MCP Tools (Claude Integration)</h2>

<div class="phase">
    <div class="phase-header">
        <div class="phase-number">12</div>
        <div class="phase-title">Model Context Protocol Tools</div>
        <div class="phase-time"><span class="badge badge-ready">12/12 WORKING</span></div>
    </div>
    <div class="phase-content">
        <p>Claude can query the codebase directly via MCP. All tools call the REST API and format responses.</p>

        <div class="config-file">
            <div class="config-header">src/mcp/server.ts - Available Tools</div>
            <div class="config-body">
<pre><span class="dim">// Graph Queries</span>
<span class="ok">search_functions</span>     <span class="dim">Search by name pattern</span>
<span class="ok">get_callers</span>          <span class="dim">Find what calls a function</span>
<span class="ok">get_callees</span>          <span class="dim">Find what a function calls</span>
<span class="ok">get_call_chain</span>       <span class="dim">Full call tree (configurable depth)</span>
<span class="ok">get_file_functions</span>   <span class="dim">List functions in a file</span>
<span class="ok">get_stats</span>            <span class="dim">Codebase statistics</span>

<span class="dim">// Semantic Queries</span>
<span class="cmd">get_touched_functions</span>  <span class="dim">Recently edited, may need annotation</span>
<span class="cmd">get_concept_map</span>        <span class="dim">Semantic domains and members</span>
<span class="cmd">query_concepts</span>         <span class="dim">Natural language search</span>
<span class="cmd">get_concept_shifts</span>     <span class="dim">Functions whose purpose changed</span>

<span class="dim">// Observability</span>
<span class="warn">evaluate_rules</span>         <span class="dim">Check all rules, return violations</span>
<span class="file">get_semantic_snapshot</span>  <span class="dim">Unified view: domains, shifts, violations, hotspots</span></pre>
            </div>
        </div>

        <div class="terminal">
<pre><span class="dim"># Claude uses MCP to understand codebase</span>
<span class="out">[Claude] Using tool: get_semantic_snapshot</span>
<span class="out">[MCP] Fetching: http://localhost:3001/api/snapshot</span>
<span class="ok">[Claude] Received: 85 functions, 3 violations, 2 hotspots</span>

<span class="dim"># Claude searches for payment-related code</span>
<span class="out">[Claude] Using tool: query_concepts</span>
<span class="out">[Claude] Query: "payment processing"</span>
<span class="ok">[MCP] Found: process_payment (92% match), charge_card (87% match)</span></pre>
        </div>

        <div class="info-box">
            <strong>How to enable MCP:</strong>
            <p style="color: #8b949e; margin-top: 0.5rem;">
                Add to Claude Code config: <code>npm run mcp</code> starts the MCP server.<br>
                Tools become available when CodeFlow API is running on localhost:3001.
            </p>
        </div>
    </div>
</div>

<!-- ANNOTATION WORKFLOW -->
<h2>Annotation Workflow</h2>

<div class="phase">
    <div class="phase-header">
        <div class="phase-number">13</div>
        <div class="phase-title">Creating & Updating Annotations</div>
        <div class="phase-time"><span class="badge badge-ready">WORKING</span></div>
    </div>
    <div class="phase-content">
        <p>Annotations can be created manually or by Claude. All versions are persisted with full history.</p>

        <div class="diagram">
<pre>
<span class="dim">Annotation Creation Flow:</span>

  Developer/Claude                  API                         Database
       |                             |                              |
       |  "This function handles    |                              |
       |   user authentication"     |                              |
       |                             |                              |
       +---- POST /api/nodes/:id/annotation ----------------------->|
                                     |                              |
                                     |  1. Find existing annotation |
                                     |  2. Mark old as superseded   |
                                     |  3. Create new version       |
                                     |  4. Check for concept shift  |
                                     |                              |
                                     |<---- { versionId, shifted } -+
                                     |                              |
       <span class="ok">Annotation saved!</span>           |                              |
       <span class="warn">Concept shift: 23% similar</span>  |                              |
</pre>
        </div>

        <h3>API Endpoints</h3>

        <div class="terminal">
<pre><span class="dim"># Create/update annotation</span>
<span class="prompt">$</span> <span class="cmd">curl -X POST localhost:3001/api/nodes/abc123/annotation \</span>
     <span class="cmd">-H "Content-Type: application/json" \</span>
     <span class="cmd">-d '{"text": "Validates user credentials...", "source": "claude"}'</span>

{
  "success": true,
  "versionId": 42,
  "superseded": 41,          <span class="dim">// Previous version ID</span>
  "conceptShift": {
    "detected": true,
    "similarity": 0.23,      <span class="dim">// 23% similar to old</span>
    "classification": "DIFFERENT"
  }
}

<span class="dim"># Get annotation history</span>
<span class="prompt">$</span> <span class="cmd">curl localhost:3001/api/nodes/abc123/annotation/history</span>

<span class="dim"># Get functions needing annotation</span>
<span class="prompt">$</span> <span class="cmd">curl localhost:3001/api/annotations/pending</span></pre>
        </div>

        <div class="config-file">
            <div class="config-header">Version History (survives all changes)</div>
            <div class="config-body">
<pre><span class="dim">// Each annotation is immutable - superseded, never deleted</span>

Version 1: "Validates payment card"
  created: 2024-01-10
  <span class="err">superseded: 2024-01-12</span>

Version 2: "Processes refund requests"
  created: 2024-01-12
  <span class="warn">superseded: 2024-01-15</span>
  <span class="warn">concept_shift: true (18% similarity)</span>

Version 3: "Handles payment refunds and sends confirmation email"
  created: 2024-01-15
  <span class="ok">current: true</span></pre>
            </div>
        </div>
    </div>
</div>

<!-- RULES ENGINE -->
<h2>Rules Engine</h2>

<div class="phase">
    <div class="phase-header">
        <div class="phase-number">14</div>
        <div class="phase-title">Observability Rules</div>
        <div class="phase-time"><span class="badge badge-working">PARTIAL</span></div>
    </div>
    <div class="phase-content">
        <p>Define rules that enforce observability standards. Evaluation works; enforcement is in progress.</p>

        <h3>Rule Conditions</h3>
        <div class="step-grid">
            <div class="step-card" style="border-left: 3px solid #3fb950;">
                <h4>missing_annotation <span class="badge badge-ready">WORKING</span></h4>
                <p>Functions without any annotation.</p>
            </div>
            <div class="step-card" style="border-left: 3px solid #3fb950;">
                <h4>stale <span class="badge badge-ready">WORKING</span></h4>
                <p>Annotation contentHash doesn't match current code.</p>
            </div>
            <div class="step-card" style="border-left: 3px solid #3fb950;">
                <h4>high_drift <span class="badge badge-ready">WORKING</span></h4>
                <p>High-severity drift unresolved.</p>
            </div>
            <div class="step-card" style="border-left: 3px solid #3fb950;">
                <h4>concept_shifted <span class="badge badge-ready">WORKING</span></h4>
                <p>Function purpose changed, needs review.</p>
            </div>
            <div class="step-card" style="border-left: 3px solid #3fb950;">
                <h4>uncovered_module <span class="badge badge-ready">WORKING</span></h4>
                <p>Module has functions but no summary.</p>
            </div>
            <div class="step-card" style="border-left: 3px solid #3fb950;">
                <h4>invariant_violation <span class="badge badge-ready">WORKING</span></h4>
                <p>Hardcoded invariant failed.</p>
            </div>
        </div>

        <h3>Rule Actions</h3>
        <div class="step-grid">
            <div class="step-card" style="border-left: 3px solid #3fb950;">
                <h4>warn <span class="badge badge-ready">WORKING</span></h4>
                <p>Log violation, broadcast via WebSocket, record in DB.</p>
            </div>
            <div class="step-card" style="border-left: 3px solid #d29922;">
                <h4>block <span class="badge badge-queue">TARGET: 1/19</span></h4>
                <p>Prevent action until violation resolved. <em>Stored but not enforced.</em></p>
            </div>
            <div class="step-card" style="border-left: 3px solid #d29922;">
                <h4>auto_regenerate <span class="badge badge-queue">TARGET: 1/19</span></h4>
                <p>Automatically regenerate annotation via Claude. <em>Defined but not wired.</em></p>
            </div>
        </div>

        <div class="terminal">
<pre><span class="dim"># Evaluate all rules</span>
<span class="prompt">$</span> <span class="cmd">curl -X POST localhost:3001/api/rules/evaluate</span>

{
  "evaluatedAt": 1705234567890,
  "violationCount": 3,
  "violations": [
    {
      "ruleId": "require-annotation",
      "ruleName": "All exported functions must be annotated",
      "condition": "missing_annotation",
      "action": "<span class="ok">warn</span>",         <span class="dim">// This works</span>
      "targets": [
        { "name": "handleRequest", "reason": "No annotation exists" }
      ]
    }
  ]
}

<span class="dim"># Create custom rule</span>
<span class="prompt">$</span> <span class="cmd">curl -X POST localhost:3001/api/rules \</span>
     <span class="cmd">-d '{"name": "Critical paths", "condition": "missing_annotation", </span>
     <span class="cmd">     "action": "warn", "threshold": 0}'</span></pre>
        </div>
    </div>
</div>

<!-- SKILLS -->
<h2>Claude Skills</h2>

<div class="phase">
    <div class="phase-header">
        <div class="phase-number">15</div>
        <div class="phase-title">Slash Commands</div>
        <div class="phase-time"><span class="badge badge-ready">2 WORKING</span></div>
    </div>
    <div class="phase-content">
        <p>Skills that Claude can invoke to interact with CodeFlow.</p>

        <div class="split">
            <div class="agent-card">
                <div class="agent-name" style="color: #3fb950;">/codeflow <span class="badge badge-ready">WORKING</span></div>
                <div class="agent-status" style="font-size: 0.85rem;">
                    <strong>What:</strong> Generate narrative explanation of codebase<br><br>
                    <strong>How:</strong> Fetches /api/snapshot, formats as human-readable summary<br><br>
                    <strong>Output:</strong><br>
                    - Concept domains and top members<br>
                    - Current health (violations, shifts)<br>
                    - Hotspots to watch<br>
                    - Advice for working in codebase
                </div>
            </div>
            <div class="agent-card">
                <div class="agent-name" style="color: #3fb950;">/codeflow-verify <span class="badge badge-ready">WORKING</span></div>
                <div class="agent-status" style="font-size: 0.85rem;">
                    <strong>What:</strong> Run golden tests to verify semantic layer<br><br>
                    <strong>How:</strong> Runs <code>npm run test:semantic</code><br><br>
                    <strong>Tests:</strong><br>
                    - Concept shift detection<br>
                    - Semantic search accuracy<br>
                    - Impact analysis<br>
                    - Invariant detection
                </div>
            </div>
        </div>

        <h3 style="margin-top: 2rem;">Planned Skills <span class="badge badge-queue">TARGET: 1/19</span></h3>

        <div class="split">
            <div class="agent-card" style="opacity: 0.7;">
                <div class="agent-name" style="color: #6e7681;">/annotate</div>
                <div class="agent-status" style="font-size: 0.85rem;">
                    Generate annotations for unannotated or stale functions.<br><br>
                    <em>Not yet implemented.</em>
                </div>
            </div>
            <div class="agent-card" style="opacity: 0.7;">
                <div class="agent-name" style="color: #6e7681;">/codeflow-fix</div>
                <div class="agent-status" style="font-size: 0.85rem;">
                    Auto-fix rule violations by regenerating annotations.<br><br>
                    <em>Not yet implemented.</em>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- FEEDBACK LOOP -->
<h2>The Feedback Loop</h2>

<div class="phase">
    <div class="phase-header">
        <div class="phase-number">16</div>
        <div class="phase-title">Claude Integration Loop</div>
        <div class="phase-time"><span class="badge badge-queue">TARGET: 1/19</span></div>
    </div>
    <div class="phase-content">
        <p>The vision: Claude automatically sees violations and fixes them. Current state: observation only.</p>

        <div class="diagram">
<pre>
<span class="dim">Current State (One-Way Observation):</span>

  Code Change ──> Analysis ──> Drift Detected ──> WebSocket Broadcast
                                                        |
                                                        v
                                                   <span class="ok">UI Shows Warning</span>
                                                        |
                                                        v
                                               <span class="warn">Developer Manually</span>
                                               <span class="warn">Asks Claude for Help</span>
                                                        |
                                                        v
                                               Claude Uses MCP Tools
                                                        |
                                                        v
                                               Developer POSTs Annotation


<span class="dim">Target State (Closed Loop) - TARGET: 1/19:</span>

  Code Change ──> Analysis ──> Drift Detected ──> <span class="err">Auto-Regenerate Rule</span>
                                                        |
                                                        v
                                               <span class="cmd">Generate Claude Prompt</span>
                                                        |
                                                        v
                                               <span class="cmd">Claude Generates Annotation</span>
                                                        |
                                                        v
                                               <span class="ok">POST to API (auto)</span>
                                                        |
                                                        v
                                               <span class="ok">Drift Resolved</span>
</pre>
        </div>

        <div class="info-box warning">
            <strong>What's Missing (Target: 1/19)</strong>
            <ul style="margin-top: 0.5rem; padding-left: 1.25rem; color: #8b949e;">
                <li><strong>auto_regenerate execution:</strong> Rule action defined but no handler</li>
                <li><strong>Claude prompt generation:</strong> Need to format violation as prompt</li>
                <li><strong>Automatic POST:</strong> Claude output needs to flow back to API</li>
                <li><strong>Block enforcement:</strong> API doesn't check block rules before accepting writes</li>
            </ul>
        </div>

        <h3>What Works Today</h3>
        <div class="step-grid">
            <div class="step-card" style="border-left: 3px solid #3fb950;">
                <h4>Automatic</h4>
                <p>File change detection, drift detection, rule evaluation, WebSocket broadcast, concept shift pre-check</p>
            </div>
            <div class="step-card" style="border-left: 3px solid #d29922;">
                <h4>Manual</h4>
                <p>Annotation creation, annotation approval, shift review, rule threshold adjustment</p>
            </div>
        </div>
    </div>
</div>

<!-- SEMANTIC SNAPSHOT -->
<h2>Semantic Snapshot</h2>

<div class="phase">
    <div class="phase-header">
        <div class="phase-number">17</div>
        <div class="phase-title">Unified Codebase View</div>
        <div class="phase-time"><span class="badge badge-ready">WORKING</span></div>
    </div>
    <div class="phase-content">
        <p>One API call to understand the entire codebase. Used by /codeflow skill and MCP.</p>

        <div class="terminal">
<pre><span class="prompt">$</span> <span class="cmd">curl localhost:3001/api/snapshot</span>

{
  "generatedAt": 1705234567890,
  "project": "codeflow-viz",

  <span class="ok">"domains"</span>: [
    {
      "name": "Authentication",
      "description": "User login and session management",
      "memberCount": 8,
      "topMembers": ["create_session", "validate_token", "logout"]
    },
    {
      "name": "Billing",
      "memberCount": 5,
      "topMembers": ["process_payment", "charge_card", "refund"]
    }
  ],

  <span class="warn">"unreviewedShifts"</span>: [
    {
      "functionName": "handle_webhook",
      "filePath": "src/api/webhooks.ts",
      "similarity": 0.23,
      "reason": "Was auth, now billing"
    }
  ],

  <span class="err">"violations"</span>: [
    {
      "rule": "public-api-annotated",
      "ruleName": "All exported functions must be annotated",
      "count": 3,
      "examples": ["handleRequest", "processQueue", "initServer"]
    }
  ],

  <span class="file">"hotspots"</span>: [
    {
      "functionName": "get_subscription",
      "filePath": "src/billing/subscription.ts",
      "callerCount": 5
    }
  ],

  "stats": {
    "totalFunctions": 85,
    "annotatedCount": 42,
    "domainCount": 6,
    "violationCount": 3,
    "shiftCount": 1
  }
}</pre>
        </div>
    </div>
</div>

<!-- MODULE SUMMARIZATION -->
<h2>Module Summarization</h2>

<div class="phase">
    <div class="phase-header">
        <div class="phase-number">18</div>
        <div class="phase-title">Module-Level Annotations</div>
        <div class="phase-time"><span class="badge badge-working">PARTIAL</span></div>
    </div>
    <div class="phase-content">
        <p>Aggregate function annotations into module summaries. Currently template-based.</p>

        <div class="split">
            <div class="agent-card">
                <div class="agent-name" style="color: #3fb950;">What Works</div>
                <div class="agent-status" style="font-size: 0.85rem;">
                    - Module coverage tracking<br>
                    - Staleness detection<br>
                    - Template-based summaries<br>
                    - API endpoints for CRUD
                </div>
            </div>
            <div class="agent-card">
                <div class="agent-name" style="color: #d29922;">Target: 1/19</div>
                <div class="agent-status" style="font-size: 0.85rem;">
                    - AI-generated summaries (currently hardcoded template)<br>
                    - Claude integration for smart summarization
                </div>
            </div>
        </div>

        <div class="terminal">
<pre><span class="dim"># Current output (template-based)</span>
<span class="out">"The analyzer module provides analysis capabilities</span>
<span class="out"> (extractFromAST, parseSource, resolveLocalCalls)"</span>

<span class="dim"># Target output (AI-generated) - 1/19</span>
<span class="out">"The analyzer module parses TypeScript and Python code</span>
<span class="out"> using tree-sitter, extracts function signatures and</span>
<span class="out"> call relationships, and builds an indexed graph for</span>
<span class="out"> fast queries. Key entry point: analyzeDirectory()."</span></pre>
        </div>
    </div>
</div>

<!-- COMPLETE FLOW -->
<h2>Complete Flow: Example</h2>

<div class="phase">
    <div class="phase-header">
        <div class="phase-number">*</div>
        <div class="phase-title">Claude edits processPayment()</div>
    </div>
    <div class="phase-content">
        <div class="diagram">
<pre>
<span class="dim">T+0ms</span>    Claude runs Edit tool on src/billing/payment.ts
              |
              v
<span class="dim">T+1ms</span>    <span class="ok">ClaudeHookAdapter</span> receives PostToolUse event
              |
              v
<span class="dim">T+2ms</span>    <span class="cmd">ChangeDetector</span> emits FileChangeEvent
              |
              v
<span class="dim">T+3ms</span>    <span class="file">ChangeAggregator</span> adds to pending batch
              |
              v
<span class="dim">T+1000ms</span> Batch window closes, aggregator triggers analysis
              |
              v
<span class="dim">T+1012ms</span> <span class="warn">AnalysisPipeline</span> parses with tree-sitter
              |
              v
<span class="dim">T+1025ms</span> Extractor yields GraphNode with new contentHash
              |
              v
<span class="dim">T+1026ms</span> <span class="err">DriftDetector</span> compares hashes
         Old: sha256:abc123
         New: sha256:xyz789
         <span class="err">DRIFT DETECTED - severity: HIGH</span>
              |
              v
<span class="dim">T+1027ms</span> <span class="file">ConceptShiftDetector</span> compares embeddings
         Old annotation: "Validates payment card"
         New behavior: (inferred from code)
         Similarity: <span class="warn">72%</span> - SIMILAR (needs review)
              |
              v
<span class="dim">T+1028ms</span> <span class="cmd">InvariantChecker</span> evaluates rules
         no-high-drift-unresolved: <span class="err">VIOLATED</span>
              |
              v
<span class="dim">T+1029ms</span> <span class="ok">WebSocket</span> broadcasts:
         - graph:update
         - drift:detected
         - rules:violation
              |
              v
<span class="dim">T+1030ms</span> UI updates in browser, shows drift warning
</pre>
        </div>
    </div>
</div>

<!-- SUMMARY -->
<h2>Summary</h2>

<div class="step-grid">
    <div class="step-card">
        <h4>1. Change Detection</h4>
        <p>Claude hooks or file watcher capture every code change instantly.</p>
    </div>
    <div class="step-card">
        <h4>2. Aggregation</h4>
        <p>Batch changes, capture git diffs, avoid duplicate analysis.</p>
    </div>
    <div class="step-card">
        <h4>3. Parsing</h4>
        <p>tree-sitter builds syntax tree in &lt;100ms per file.</p>
    </div>
    <div class="step-card">
        <h4>4. Extraction</h4>
        <p>Extract functions, classes, calls. Calculate content hashes.</p>
    </div>
    <div class="step-card">
        <h4>5. Graph Building</h4>
        <p>Indexed in-memory graph with fast queries.</p>
    </div>
    <div class="step-card">
        <h4>6. Annotations</h4>
        <p>AI/human descriptions attached to functions via stableId.</p>
    </div>
    <div class="step-card">
        <h4>7. Drift Detection</h4>
        <p>Content hash comparison finds stale annotations.</p>
    </div>
    <div class="step-card">
        <h4>8. Concept Shifts</h4>
        <p>Embedding similarity detects purpose changes.</p>
    </div>
    <div class="step-card">
        <h4>9. Invariants</h4>
        <p>Hardcoded rules enforce observability contracts.</p>
    </div>
    <div class="step-card">
        <h4>10. Impact Analysis</h4>
        <p>Trace callers to understand blast radius.</p>
    </div>
    <div class="step-card">
        <h4>11. Storage</h4>
        <p>SQLite persists all semantic metadata.</p>
    </div>
    <div class="step-card">
        <h4>12. Output</h4>
        <p>REST API, WebSocket, MCP for humans and Claude.</p>
    </div>
</div>

<div class="info-box success" style="margin-top: 2rem;">
    <h3 style="color: #3fb950; margin-bottom: 0.75rem;">The Core Insight</h3>
    <p style="font-family: 'SF Mono', monospace; font-size: 0.9rem;">
        <strong>Parsing</strong> tells you what code <em>is</em>.<br>
        <strong>Annotations</strong> tell you what code <em>does</em>.<br>
        <strong>Drift detection</strong> tells you when they <em>disagree</em>.<br>
        <strong>Concept shifts</strong> tell you when <em>meaning</em> changed.<br><br>
        Together: semantic observability for AI-assisted development.
    </p>
</div>

<!-- CHANGE HISTORY -->
<h2>Change History</h2>

<div class="phase">
    <div class="phase-header">
        <div class="phase-number">19</div>
        <div class="phase-title">Change Event Log</div>
        <div class="phase-time"><span class="badge badge-working">PARTIAL</span></div>
    </div>
    <div class="phase-content">
        <p>Track what changed and when. Event log works; git diff capture is not implemented.</p>

        <div class="split">
            <div class="agent-card">
                <div class="agent-name" style="color: #3fb950;">What Works</div>
                <div class="agent-status" style="font-size: 0.85rem;">
                    - Change event logging (file, type, timestamp)<br>
                    - Source tracking (claude_hook vs fs_watcher)<br>
                    - Content hash storage<br>
                    - Query via API
                </div>
            </div>
            <div class="agent-card">
                <div class="agent-name" style="color: #d29922;">Target: 1/19</div>
                <div class="agent-status" style="font-size: 0.85rem;">
                    - Git diff capture (before/after comparison)<br>
                    - Baseline version storage<br>
                    - Diff visualization in UI
                </div>
            </div>
        </div>

        <div class="terminal">
<pre><span class="dim"># Query recent changes</span>
<span class="prompt">$</span> <span class="cmd">curl localhost:3001/api/changes</span>

{
  "changes": [
    {
      "id": "uuid-123",
      "filePath": "src/api/routes.ts",
      "type": "modify",
      "source": "<span class="ok">claude_hook</span>",
      "timestamp": 1705234567890,
      "contentHash": "sha256:abc..."
    }
  ]
}

<span class="dim"># Note: No git diff content captured yet</span></pre>
        </div>
    </div>
</div>

<!-- KNOWN LIMITATIONS -->
<h2>Known Limitations</h2>

<div class="phase">
    <div class="phase-header">
        <div class="phase-number">!</div>
        <div class="phase-title">Technical Caveats</div>
    </div>
    <div class="phase-content">
        <div class="step-grid">
            <div class="step-card" style="border-left: 3px solid #f85149;">
                <h4>Embedding Model Lazy Load</h4>
                <p>@xenova/transformers loads on first use. If load fails, semantic features return empty results (no error). Monitor for silent failures.</p>
            </div>
            <div class="step-card" style="border-left: 3px solid #f85149;">
                <h4>MCP Depends on API</h4>
                <p>All 12 MCP tools call localhost:3001. If API not running, tools fail. No graceful degradation.</p>
            </div>
            <div class="step-card" style="border-left: 3px solid #d29922;">
                <h4>No Git Diff in Events</h4>
                <p>Change events track that file changed, not what changed. No before/after comparison stored.</p>
            </div>
            <div class="step-card" style="border-left: 3px solid #d29922;">
                <h4>Concept Shift Requires Manual Review</h4>
                <p>UNCLEAR cases (50-85% similarity) don't auto-prompt Claude. Developer must investigate.</p>
            </div>
        </div>

        <div class="info-box error" style="margin-top: 1.5rem;">
            <strong>Critical Gaps for Production</strong>
            <ul style="margin-top: 0.5rem; padding-left: 1.25rem; color: #8b949e;">
                <li>No audit logging for rule evaluations (who triggered, when, outcome)</li>
                <li>No authentication/authorization on API endpoints</li>
                <li>No rate limiting on annotation POSTs</li>
                <li>No backup/restore for SQLite database</li>
            </ul>
        </div>
    </div>
</div>

<!-- TESTING -->
<h2>Testing</h2>

<div class="phase">
    <div class="phase-header">
        <div class="phase-number">T</div>
        <div class="phase-title">Test Coverage</div>
        <div class="phase-time"><span class="badge badge-ready">94 PASSING</span></div>
    </div>
    <div class="phase-content">
        <div class="config-file">
            <div class="config-header">Test Suites</div>
            <div class="config-body">
<pre><span class="ok">test/rules.test.ts</span>           <span class="dim">Rule engine, evaluation, storage</span>
<span class="ok">test/hooks.test.ts</span>           <span class="dim">Claude hook adapter, file watcher</span>
<span class="ok">test/api.test.ts</span>             <span class="dim">REST API endpoints</span>
<span class="ok">test/analyzer.test.ts</span>        <span class="dim">Parsing, extraction, graph building</span>
<span class="ok">test/e2e.test.ts</span>             <span class="dim">End-to-end flows</span>
<span class="ok">test/semantic-golden.test.ts</span> <span class="dim">Semantic layer verification (8 tests)</span>

<span class="dim">Run all:</span> npm run test:run
<span class="dim">Semantic only:</span> npm run test:semantic</pre>
            </div>
        </div>

        <h3 style="margin-top: 1.5rem;">Golden Tests (Semantic Verification)</h3>
        <p>These tests prove the semantic layer understands <em>meaning</em>, not just moves data.</p>

        <div class="step-grid">
            <div class="step-card" style="border-left: 3px solid #3fb950;">
                <h4>Concept Shift Detection</h4>
                <p>"Auth" vs "billing" → similarity 6.7% → DIFFERENT classification</p>
            </div>
            <div class="step-card" style="border-left: 3px solid #3fb950;">
                <h4>Semantic Search</h4>
                <p>Query "user login" → auth functions rank higher than billing</p>
            </div>
            <div class="step-card" style="border-left: 3px solid #3fb950;">
                <h4>Impact Analysis</h4>
                <p>get_subscription → correctly reports 5 callers</p>
            </div>
            <div class="step-card" style="border-left: 3px solid #3fb950;">
                <h4>Invariant Detection</h4>
                <p>Exported functions without annotations → violation raised</p>
            </div>
        </div>

        <div class="terminal">
<pre><span class="dim"># Verify semantic layer works</span>
<span class="prompt">$</span> <span class="cmd">npm run test:semantic</span>

<span class="ok">✓</span> Concept Shift Detection > detects when annotation purpose changes significantly
<span class="ok">✓</span> Concept Shift Detection > recognizes similar annotations as same concept
<span class="ok">✓</span> Semantic Search > ranks results by semantic relevance
<span class="ok">✓</span> Impact Analysis > calculates correct blast radius for high-impact function
<span class="ok">✓</span> Impact Analysis > identifies high-impact functions correctly
<span class="ok">✓</span> Invariant Detection > flags exported functions without annotations
<span class="ok">✓</span> Invariant Detection > flags critical path functions without annotations
<span class="ok">✓</span> Invariant Detection > returns summary with all invariant results

Test Files  1 passed (1)
     Tests  <span class="ok">8 passed</span> (8)</pre>
        </div>
    </div>
</div>

<!-- STATUS MATRIX -->
<h2>Implementation Status Matrix</h2>

<div class="phase">
    <div class="phase-header">
        <div class="phase-number">*</div>
        <div class="phase-title">What's Working vs. In Progress</div>
    </div>
    <div class="phase-content">
        <div class="config-file">
            <div class="config-header">Status as of January 2025</div>
            <div class="config-body">
<pre>
<span class="dim">COMPONENT                        STATUS          TESTS    NOTES</span>
<span class="dim">─────────────────────────────────────────────────────────────────</span>
<span class="ok">Persistence Layer</span>                WORKING         94/94    SQLite + version history
<span class="ok">Analysis Pipeline</span>                WORKING         ✓        tree-sitter + extraction
<span class="ok">Graph Building</span>                   WORKING         ✓        Indexed, fast queries
<span class="ok">Annotations</span>                      WORKING         ✓        Full CRUD + history
<span class="ok">Drift Detection</span>                  WORKING         ✓        Severity calculation
<span class="ok">Rules Evaluation</span>                 WORKING         ✓        All 6 conditions
<span class="ok">MCP Tools</span>                        WORKING         -        12/12 tools
<span class="ok">WebSocket Events</span>                 WORKING         ✓        Real-time broadcast
<span class="ok">Semantic Snapshot</span>                WORKING         ✓        Unified view
<span class="ok">/codeflow skill</span>                  WORKING         -        Narrative generation
<span class="ok">/codeflow-verify skill</span>           WORKING         ✓        Golden tests

<span class="warn">Concept Shifts</span>                   PARTIAL         ✓        Pre-check works, Claude prompt manual
<span class="warn">Module Summarization</span>             PARTIAL         ✓        Template-based, not AI

<span class="err">Block Action</span>                     STUBBED         -        Defined, not enforced
<span class="err">Auto-Regenerate</span>                  STUBBED         -        Defined, no handler
<span class="err">Claude Feedback Loop</span>             NOT IMPL        -        One-way observation only
<span class="err">/annotate skill</span>                  NOT IMPL        -        Planned
<span class="err">/codeflow-fix skill</span>              NOT IMPL        -        Planned
</pre>
            </div>
        </div>

        <h3 style="margin-top: 1.5rem;">Target: January 19, 2025</h3>
        <div class="step-grid">
            <div class="step-card" style="border-left: 3px solid #f85149;">
                <h4>Wire auto_regenerate</h4>
                <p>Execute rule action, generate Claude prompt, POST result back to API.</p>
            </div>
            <div class="step-card" style="border-left: 3px solid #f85149;">
                <h4>Block enforcement</h4>
                <p>API checks block rules before accepting writes.</p>
            </div>
            <div class="step-card" style="border-left: 3px solid #f85149;">
                <h4>/annotate skill</h4>
                <p>Claude generates annotations for pending functions.</p>
            </div>
            <div class="step-card" style="border-left: 3px solid #f85149;">
                <h4>AI module summaries</h4>
                <p>Replace template with Claude-generated summaries.</p>
            </div>
        </div>
    </div>
</div>

<!-- EXECUTIVE SUMMARY -->
<h2>Executive Summary</h2>

<div class="info-box" style="border-left-color: #58a6ff;">
    <h3 style="color: #58a6ff; margin-bottom: 0.75rem;">What This System Does</h3>
    <ul style="padding-left: 1.25rem; color: #c9d1d9;">
        <li><strong>Tracks</strong> every code change in real-time (Claude hooks + file watcher)</li>
        <li><strong>Analyzes</strong> code structure with tree-sitter (functions, classes, calls)</li>
        <li><strong>Annotates</strong> what code does (not just what it is)</li>
        <li><strong>Detects</strong> when documentation drifts from implementation</li>
        <li><strong>Enforces</strong> observability rules (evaluation working, enforcement in progress)</li>
        <li><strong>Integrates</strong> with Claude via 12 MCP tools</li>
    </ul>
</div>

<div class="info-box warning" style="margin-top: 1rem;">
    <h3 style="color: #d29922; margin-bottom: 0.75rem;">What's Not Done Yet (Target: 1/19)</h3>
    <ul style="padding-left: 1.25rem; color: #c9d1d9;">
        <li><strong>Automatic annotation regeneration</strong> - Rule action exists but no execution</li>
        <li><strong>Block enforcement</strong> - Rules can warn but not prevent</li>
        <li><strong>Claude feedback loop</strong> - Observation only, no auto-prompting</li>
        <li><strong>Smart module summaries</strong> - Template-based, not AI-generated</li>
    </ul>
</div>

<div class="info-box success" style="margin-top: 1rem;">
    <h3 style="color: #3fb950; margin-bottom: 0.75rem;">Production Readiness</h3>
    <ul style="padding-left: 1.25rem; color: #c9d1d9;">
        <li><strong>Data layer:</strong> Production-ready (SQLite + persistence + versioning)</li>
        <li><strong>Analysis:</strong> Production-ready (parsing + graph + drift detection)</li>
        <li><strong>Rules:</strong> Evaluation production-ready, enforcement in progress</li>
        <li><strong>Claude loop:</strong> MCP tools ready, automatic feedback not implemented</li>
        <li><strong>Test coverage:</strong> 94 passing tests, semantic golden tests included</li>
    </ul>
</div>

</div>

<footer>
    <p>CodeFlow Visualizer - Making the AI coding black box transparent</p>
    <p style="margin-top: 0.5rem; font-size: 0.75rem;">
        Last updated: January 15, 2025 | Next milestone: January 19, 2025
    </p>
</footer>

</body>
</html>
